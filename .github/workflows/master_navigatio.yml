# Docs for the Azure Web Apps Deploy action: https://github.com/Azure/webapps-deploy
# More GitHub Actions for Azure: https://github.com/Azure/actions

name: Build and deploy Node.js app to Azure Web App - Navigatio

on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]

jobs:
  test-and-build:
    runs-on: ubuntu-latest
    
    strategy:
      matrix:
        node-version: [18.x]
    
    steps:
    - uses: actions/checkout@v3
    
    - name: Use Node.js ${{ matrix.node-version }}
      uses: actions/setup-node@v3
      with:
        node-version: ${{ matrix.node-version }}
        cache: 'npm'
    
    # Install frontend dependencies
    - name: Install frontend dependencies
      working-directory: ./frontend
      run: npm ci
    
    # Run frontend tests
    - name: Run frontend tests
      working-directory: ./frontend
      run: npm test -- --watchAll=false
    
    # Build frontend
    - name: Build frontend
      working-directory: ./frontend
      run: npm run build
    
    # Install backend dependencies
    - name: Install backend dependencies
      working-directory: ./backend
      run: npm ci
      
    # Add environment variables for backend tests (update these as needed)
    - name: Set up environment variables
      run: |
        echo "NODE_ENV=test" >> $GITHUB_ENV
        echo "MONGODB_URI=mongodb://localhost:27017/test" >> $GITHUB_ENV
        echo "JWT_SECRET=test-secret" >> $GITHUB_ENV
    
    # Run backend tests (uncomment and configure when tests are added)
    # - name: Run backend tests
    #   working-directory: ./backend
    #   run: npm test
    
    # Optional: Deploy to production (uncomment and configure as needed)
    # deploy:
    #   needs: test-and-build
    #   runs-on: ubuntu-latest
    #   if: github.ref == 'refs/heads/main' || github.ref == 'refs/heads/master'
    #   steps:
    #     - uses: actions/checkout@v3
    #     - name: Deploy to production
    #       run: |
    #         # Add your deployment commands here
    #         # For example, using SSH to connect to your server
    #         # or using a deployment service like Vercel, Netlify, etc.
